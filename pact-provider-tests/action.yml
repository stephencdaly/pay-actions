name: "Run pact provider tests"
description: "Runs pact provider tests"
inputs:
  pact-broker-username:
    description: Pact broker username
    required: true
  pact-broker-password:
    description: Pact broker password
    required: true
  consumer:
    description: The pact consumer name
    required: true
  consumer-tag:
    description: The tag for consumer pact file to check for providers needing validation against
    required: true
  provider:
    description: The pact provider name
    required: true
  providers-needing-validation:
    description: List of providers that need validating for this consumer version
    required: true
runs:
  using: "composite"
  steps:
    - run: |
        if [[ "${{ inputs.providers-needing-validation }}" != *"${{ inputs.provider }}"* ]]; then
          echo "All pacts already verified"
          exit 0
        fi

        cd ledger

        provider_version="$(git rev-parse HEAD)"
        echo "Provider version: $provider_version"

        mvn test \
          -DrunContractTests \
          -DCONSUMER="${{ inputs.consumer }}" \
          -DPACT_CONSUMER_TAG="${{ inputs.consumer_tag }}" \
          -Dpact.provider.version="$provider_version" \
          -Dpact.verifier.publishResults=true \
          -DPACT_BROKER_HOST="pay-pact-broker.cloudapps.digital" \
          -DPACT_BROKER_USERNAME="${{ inputs.pact-broker-username }}" \
          -DPACT_BROKER_PASSWORD="${{ inputs.pact-broker-password }}"
      shell: bash
